<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urbana Vision - Sistema Completo + Marketing Intelligence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #134e4a 0%, #7c2d12 50%, #1e3a8a 100%); 
            color: white; 
            padding: 15px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .btn-primary { background: linear-gradient(45deg, #3b82f6, #1d4ed8); }
        .btn-danger { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .btn-warning { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .btn-whatsapp { background: linear-gradient(45deg, #25d366, #128c7e); }
        .btn-success { background: linear-gradient(45deg, #10b981, #059669); }
        .btn-lab { background: linear-gradient(45deg, #7c3aed, #a855f7); }
        .btn-marketing { background: linear-gradient(45deg, #00d4aa, #1a365d); }
        .btn-audio { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .btn-video { background: linear-gradient(45deg, #a55eea, #26de81); }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .section.active { display: block; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .input, .select, .textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #444;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
            backdrop-filter: blur(5px);
        }
        .input::placeholder, .textarea::placeholder { color: rgba(255, 255, 255, 0.7); }
        .textarea { min-height: 100px; }
        
        .camera-box {
            width: 100%;
            height: 250px;
            background: #000;
            border: 2px dashed #666;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .producto-item, .cliente-item, .orden-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .producto-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .lab-section {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.2), rgba(168, 85, 247, 0.2));
            border: 2px solid #7c3aed;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .marketing-section {
            background: linear-gradient(45deg, rgba(0, 212, 170, 0.2), rgba(26, 54, 93, 0.2));
            border: 2px solid #00d4aa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .news-item {
            background: rgba(255,107,107,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ff6b6b;
        }
        
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10b981, #059669);
            padding: 15px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            max-width: 350px;
            word-wrap: break-word;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .stat-box {
            background: rgba(16, 185, 129, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #10b981;
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #10b981;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .backup-status {
            background: rgba(34, 139, 34, 0.2);
            border: 2px solid #22c55e;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #10b981, #059669);
        }
        .record-btn.recording {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            animation: pulse 1s infinite;
        }
        
        .audio-recorder {
            background: linear-gradient(45deg, rgba(255, 107, 107, 0.2), rgba(238, 90, 36, 0.2));
            border: 2px solid #ff6b6b;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .ia-suggestion {
            background: linear-gradient(45deg, rgba(0, 212, 170, 0.2), rgba(26, 54, 93, 0.2));
            border: 1px solid #00d4aa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #00d4aa;
        }
        
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .platform-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .platform-card:hover { transform: scale(1.05); }
        
        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .voice-to-text {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px dashed #00d4aa;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘“ URBANA VISION - SISTEMA COMPLETO</h1>
            <p>ğŸ“± 809-713-5307 | ğŸŒ Sistema con Marketing Intelligence</p>
            
            <!-- BACKUP STATUS -->
            <div class="backup-status">
                <div class="status-indicator"></div>
                <div>
                    <strong>ğŸ”’ BACKUP AUTOMÃTICO ACTIVO</strong>
                    <div style="font-size: 12px; opacity: 0.8;">
                        Netlify Pro - Ãšltimo backup: <span id="ultimoBackup">Hace 2 horas</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- MENÃš PRINCIPAL -->
        <div id="menu" class="section active">
            <div class="grid">
                <!-- DASHBOARD -->
                <div class="card">
                    <h3>ğŸ“Š Dashboard</h3>
                    <div class="stat-box">
                        <div class="stat-number" id="totalProductos">0</div>
                        <div>Productos</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" id="totalOrdenes">0</div>
                        <div>Ã“rdenes Lab</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" id="totalClientes">0</div>
                        <div>Clientes</div>
                    </div>
                </div>

                <!-- REPORTES DEL NEGOCIO -->
                <div class="card">
                    <h3>ğŸ’° Reportes del Negocio</h3>
                    <button class="btn btn-warning" onclick="mostrar('reportes')">ğŸ“Š Ver Reportes</button>
                    <button class="btn btn-success" onclick="mostrar('facturacion')">ğŸ“„ FacturaciÃ³n</button>
                    <button class="btn btn-primary" onclick="mostrar('cuentas')">ğŸ’µ Cuentas x Cobrar</button>
                    <button class="btn btn-danger" onclick="mostrar('deudas')">ğŸ“‹ Cuentas x Pagar</button>
                </div>

                <!-- LABORATORIO PURO -->
                <div class="card lab-section">
                    <h3>ğŸ”¬ LABORATORIO PURO</h3>
                    <p style="font-size: 12px; color: #a855f7;">4 pasos simples - Sin datos financieros de venta</p>
                    <button class="btn btn-lab" onclick="mostrar('laboratorio')">ğŸ”¬ Nueva Orden Lab</button>
                    <button class="btn btn-lab" onclick="mostrar('ordenes')">ğŸ“‹ Ver Ã“rdenes</button>
                </div>

                <!-- MARKETING INTELLIGENCE -->
                <div class="card marketing-section">
                    <h3>ğŸ§  MARKETING INTELLIGENCE RD</h3>
                    <p style="font-size: 12px; color: #00d4aa;">Audio/Video/Visual + IA para dominicanos</p>
                    <button class="btn btn-marketing" onclick="mostrar('marketing_intelligence')">ğŸ¤ Audio/Video IA</button>
                    <button class="btn btn-whatsapp" onclick="mostrar('inventario')">ğŸ“¦ Inventario</button>
                    <button class="btn btn-whatsapp" onclick="mostrar('marketing')">ğŸ“± Marketing</button>
                    <button class="btn btn-whatsapp" onclick="mostrar('noticias')">ğŸ“° InfoFlash</button>
                </div>

                <!-- GESTIÃ“N GENERAL -->
                <div class="card">
                    <h3>ğŸ‘¥ GestiÃ³n General</h3>
                    <button class="btn btn-primary" onclick="mostrar('clientes')">ğŸ‘¥ Base Clientes</button>
                    <button class="btn btn-success" onclick="backup()">ğŸ’¾ Backup Manual</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             ğŸ§  MARKETING INTELLIGENCE RD
             ======================================== -->
        <div id="marketing_intelligence" class="section">
            <div class="marketing-section">
                <h2>ğŸ§  Marketing Intelligence RD - Audio/Video/Visual</h2>
                <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
                
                <p style="color: #00d4aa; margin: 15px 0; font-weight: bold;">
                    ğŸ‡©ğŸ‡´ Adaptado para dominicanos: MÃ¡s AUDIO/VIDEO, menos texto
                </p>
                
                <!-- GRABADOR DE AUDIO INTELIGENTE -->
                <div class="audio-recorder">
                    <h3>ğŸ¤ GRABADOR DE NOTAS DE VOZ INTELIGENTE</h3>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Para dominicanos que prefieren HABLAR que escribir</p>
                    
                    <div class="audio-controls">
                        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">ğŸ¤</button>
                        <div>
                            <div>â±ï¸ <span id="tiempoGrabacion">00:00</span></div>
                            <div id="estadoGrabacion">Listo para grabar</div>
                        </div>
                    </div>
                    
                    <audio id="audioPlayback" controls style="width: 100%; margin: 15px 0; display: none;"></audio>
                    
                    <div class="voice-to-text">
                        <h4>ğŸ“ Texto automÃ¡tico (IA convierte tu voz):</h4>
                        <div id="textoConvertido" style="min-height: 60px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 10px 0;">
                            Tu voz se convertirÃ¡ automÃ¡ticamente a texto aquÃ­...
                        </div>
                        <button class="btn btn-whatsapp" onclick="enviarAudio()">ğŸ“± Enviar Audio + Texto</button>
                        <button class="btn btn-marketing" onclick="aplicarTonoDominicano()">ğŸ‡©ğŸ‡´ Aplicar Tono RD</button>
                    </div>
                </div>
                
                <!-- TEMPLATES VISUALES DOMINICANOS -->
                <div class="card">
                    <h3>ğŸ¨ Templates Visuales Dominicanos</h3>
                    <p style="opacity: 0.9; margin-bottom: 15px;">DiseÃ±os que conectan con la cultura dominicana</p>
                    
                    <div class="platform-grid">
                        <div class="platform-card" style="background: linear-gradient(45deg, #25d366, #128c7e);" onclick="crearTemplateWhatsApp()">
                            <div style="font-size: 30px;">ğŸ“±</div>
                            <div><strong>WhatsApp</strong></div>
                            <div style="font-size: 12px;">Estados + Grupos</div>
                        </div>
                        <div class="platform-card" style="background: linear-gradient(45deg, #e4405f, #833ab4);" onclick="crearTemplateInstagram()">
                            <div style="font-size: 30px;">ğŸ“·</div>
                            <div><strong>Instagram</strong></div>
                            <div style="font-size: 12px;">Posts + Stories</div>
                        </div>
                        <div class="platform-card" style="background: linear-gradient(45deg, #000, #ff0050);" onclick="crearTemplateTikTok()">
                            <div style="font-size: 30px;">ğŸµ</div>
                            <div><strong>TikTok</strong></div>
                            <div style="font-size: 12px;">Videos virales</div>
                        </div>
                        <div class="platform-card" style="background: linear-gradient(45deg, #1877f2, #42a5f5);" onclick="crearTemplateFacebook()">
                            <div style="font-size: 30px;">ğŸ“˜</div>
                            <div><strong>Facebook</strong></div>
                            <div style="font-size: 12px;">Marketplace</div>
                        </div>
                    </div>
                    
                    <div id="templateGenerado" style="display: none; margin-top: 20px;">
                        <h4>âœ¨ Template personalizado:</h4>
                        <div id="contenidoTemplate" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 10px 0;"></div>
                        <button class="btn btn-whatsapp" onclick="enviarTemplate()">ğŸ“± Enviar Ahora</button>
                        <button class="btn btn-video" onclick="crearVideoRapido()">ğŸ¥ Crear Video</button>
                    </div>
                </div>
                
                <!-- IA QUE APRENDE DEL COMPORTAMIENTO DOMINICANO -->
                <div class="card">
                    <h3>ğŸ¤– IA que entiende a los dominicanos</h3>
                    
                    <div class="ia-suggestion">
                        <h4>ğŸ¯ IA detectÃ³:</h4>
                        <p>"En RD, los videos cortos (15-30 seg) con mÃºsica tienen 340% mÃ¡s engagement que texto. Los domingos 7-9 PM es el momento de oro para promociones."</p>
                        <button class="btn btn-video" onclick="crearVideoOptimizado()">ğŸ¥ Crear Video Optimizado</button>
                    </div>
                    
                    <div class="ia-suggestion">
                        <h4>ğŸ’¡ RecomendaciÃ³n cultural:</h4>
                        <p>"Usa expresiones dominicanas: 'Klk', 'Eso tÃ¡ brutal', 'Dale que vamo a ve'. El 78% de tus clientes responde mejor a tono informal."</p>
                        <button class="btn btn-whatsapp" onclick="aplicarTonoDominicano()">ğŸ‡©ğŸ‡´ Aplicar Tono RD</button>
                    </div>
                    
                    <div class="ia-suggestion">
                        <h4>ğŸ“± PatrÃ³n detectado:</h4>
                        <p>"Tus clientes ven Stories en Instagram 6-8 AM (cafÃ©) y 6-8 PM (llegando a casa). Programa contenido en estos horarios."</p>
                        <button class="btn btn-marketing" onclick="programarContenido()">ğŸ“… Programar Contenido</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             ğŸ”¬ MÃ“DULO LABORATORIO (SEPARADO RADICAL)
             ======================================== -->
        <div id="laboratorio" class="section">
            <div class="lab-section">
                <h2>ğŸ”¬ Orden al Laboratorio - Flujo de 4 Pasos</h2>
                <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
                
                <p style="color: #fbbf24; margin: 15px 0;">
                    âš ï¸ SOLO datos tÃ©cnicos - SIN precios de venta, abonos o gestiÃ³n clientes
                </p>
                
                <div class="card">
                    <h3>ğŸ“¸ PASO 1: Foto de Receta (AUTOMÃTICA)</h3>
                    <div class="camera-box" id="cameraBoxReceta">
                        <div id="placeholderReceta">
                            <div style="font-size: 50px;">ğŸ“¸</div>
                            <div>Click para foto de receta</div>
                        </div>
                        <video id="videoReceta" style="display: none; width: 100%; height: 100%;" autoplay></video>
                    </div>
                    <button class="btn btn-primary" onclick="toggleCameraReceta()" id="cameraBtnReceta">ğŸ“¸ Tomar Foto Receta</button>
                    <img id="previewReceta" style="display: none; width: 100%; margin: 10px 0; border-radius: 5px;">
                </div>
                
                <div class="card">
                    <h3>ğŸ“¸ PASO 2: Foto de Montura (AUTOMÃTICA)</h3>
                    <div class="camera-box" id="cameraBoxMontura">
                        <div id="placeholderMontura">
                            <div style="font-size: 50px;">ğŸ“¸</div>
                            <div>Click para foto de montura</div>
                        </div>
                        <video id="videoMontura" style="display: none; width: 100%; height: 100%;" autoplay></video>
                    </div>
                    <button class="btn btn-primary" onclick="toggleCameraMontura()" id="cameraBtnMontura">ğŸ“¸ Tomar Foto Montura</button>
                    <img id="previewMontura" style="display: none; width: 100%; margin: 10px 0; border-radius: 5px;">
                </div>
                
                <div class="card">
                    <h3>ğŸ‘¤ Cliente que Compra (para cuentas por cobrar)</h3>
                    <input type="text" id="clienteLaboratorio" class="input" placeholder="Nombre del cliente (se guardarÃ¡ automÃ¡ticamente)" list="clientesDatalistLab">
                    <datalist id="clientesDatalistLab">
                        <!-- Se llena automÃ¡ticamente -->
                    </datalist>
                    <input type="number" id="precioVentaLab" class="input" placeholder="Precio de venta al cliente RD$">
                    <input type="text" id="laboratorioNombre" class="input" placeholder="Nombre del laboratorio" list="laboratoriosDatalistLab">
                    <datalist id="laboratoriosDatalistLab">
                        <!-- Se llena automÃ¡ticamente -->
                    </datalist>
                </div>
                
                <div class="card">
                    <h3>âš™ï¸ PASO 3: Datos TÃ©cnicos Obligatorios</h3>
                    
                    <h4 style="color: #7c3aed; margin: 15px 0;">ğŸ‘ï¸ GRADUACIÃ“N OJO DERECHO (OD)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Esfera:</label>
                            <input type="text" id="esferaOD" class="input" placeholder="-2.50">
                        </div>
                        <div>
                            <label>Cilindro:</label>
                            <input type="text" id="cilindroOD" class="input" placeholder="-1.00">
                        </div>
                        <div>
                            <label>Eje:</label>
                            <input type="number" id="ejeOD" class="input" placeholder="90">
                        </div>
                    </div>
                    
                    <h4 style="color: #7c3aed; margin: 15px 0;">ğŸ‘ï¸ GRADUACIÃ“N OJO IZQUIERDO (OI)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Esfera:</label>
                            <input type="text" id="esferaOI" class="input" placeholder="-2.25">
                        </div>
                        <div>
                            <label>Cilindro:</label>
                            <input type="text" id="cilindroOI" class="input" placeholder="-0.75">
                        </div>
                        <div>
                            <label>Eje:</label>
                            <input type="number" id="ejeOI" class="input" placeholder="85">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            <label>ğŸ“ DP (Distancia Pupilar):</label>
                            <input type="number" id="distanciaPupilar" class="input" placeholder="62" min="50" max="80">
                        </div>
                        <div>
                            <label>ğŸ“ Altura del Lente:</label>
                            <input type="number" id="alturaLente" class="input" placeholder="28" min="15" max="50">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label>ğŸ” Tipo de Lente:</label>
                            <select id="tipoLente" class="select">
                                <option value="">Seleccionar tipo</option>
                                <option value="Monofocal">Monofocal</option>
                                <option value="Bifocal">Bifocal</option>
                                <option value="Progresivo">Progresivo</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div>
                            <label>ğŸ’ Material:</label>
                            <select id="materialLente" class="select">
                                <option value="">Seleccionar material</option>
                                <option value="Policarbonato">Policarbonato</option>
                                <option value="CR-39">CR-39</option>
                                <option value="High Index">High Index</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div>
                            <label>â• ADD (solo progresivos):</label>
                            <input type="text" id="addLente" class="input" placeholder="+2.00">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label>ğŸ’° Costo de Laboratorio (ÃšNICO dato econÃ³mico):</label>
                        <input type="number" id="costoLab" class="input" placeholder="RD$ 0.00">
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“± PASO 4: Enviar por WhatsApp</h3>
                    <button class="btn btn-lab" onclick="enviarOrdenLaboratorio()" style="font-size: 16px; padding: 15px 30px;">
                        ğŸ“± Enviar Orden Completa al Laboratorio
                    </button>
                    <button class="btn btn-warning" onclick="limpiarFormularioLab()">ğŸ”„ Limpiar</button>
                </div>
            </div>
        </div>

        <!-- Ã“RDENES DE LABORATORIO -->
        <div id="ordenes" class="section">
            <h2>ğŸ“‹ Ã“rdenes de Laboratorio Pendientes</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>ğŸ”¬ Cotejo de Ã“rdenes Completadas</h3>
                <p style="color: #7c3aed; font-size: 14px;">Cuando el laboratorio entregue las Ã³rdenes, mÃ¡rcalas como "Entregadas" y se convertirÃ¡n en cuentas por cobrar</p>
            </div>
            
            <div id="listaOrdenesLab"></div>
        </div>

        <!-- ========================================
             ğŸ“± MÃ“DULO MARKETING (SEPARADO RADICAL)
             ======================================== -->
        <div id="marketing" class="section">
            <div class="marketing-section">
                <h2>ğŸ“± Centro de Marketing - Separado del Laboratorio</h2>
                <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
                
                <div class="grid">
                    <div class="card">
                        <h3>ğŸ“¸ PromociÃ³n con Foto</h3>
                        <div class="camera-box" id="cameraBoxPromo">
                            <div id="placeholderPromo">
                                <div style="font-size: 50px;">ğŸ“¸</div>
                                <div>Foto promocional</div>
                            </div>
                            <video id="videoPromo" style="display: none; width: 100%; height: 100%;" autoplay></video>
                        </div>
                        <button class="btn btn-primary" onclick="toggleCameraPromo()" id="cameraBtnPromo">ğŸ“¸ Tomar Foto</button>
                        <img id="previewPromo" style="display: none; width: 100%; margin: 10px 0; border-radius: 5px;">
                        
                        <textarea id="mensajePromo" class="textarea" placeholder="Mensaje promocional...">ğŸ Â¡OFERTA ESPECIAL!

âœ¨ Producto disponible
ğŸ’° Precio especial  
ğŸ“± 809-713-5307</textarea>
                        
                        <button class="btn btn-whatsapp" onclick="enviarPromocion()">ğŸ“± Enviar PromociÃ³n</button>
                    </div>

                    <div class="card">
                        <h3>ğŸ“ Subir desde MÃ³vil (Foto/Video)</h3>
                        <div style="border: 2px dashed #25d366; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; background: rgba(37, 211, 102, 0.1);" onclick="document.getElementById('archivoMovil').click()">
                            <div style="font-size: 40px;">ğŸ“±</div>
                            <div>Click para subir foto/video del mÃ³vil</div>
                            <div style="font-size: 12px; opacity: 0.7;">JPG, PNG, MP4, MOV</div>
                        </div>
                        <input type="file" id="archivoMovil" style="display: none;" accept="image/*,video/*" onchange="manejarArchivoMovil(this)">
                        <div id="previewArchivoMovil" style="margin: 10px 0;"></div>
                        
                        <textarea id="mensajeArchivoMovil" class="textarea" placeholder="Mensaje para el archivo...">ğŸ“± Â¡Mira esto!

Te va a encantar.

ğŸ“± 809-713-5307</textarea>
                        
                        <button class="btn btn-whatsapp" onclick="compartirArchivoMovil()">ğŸ“± Compartir Archivo</button>
                    </div>

                    <div class="card">
                        <h3>ğŸ”— Compartir Enlaces (TikTok, YouTube, IG, etc.)</h3>
                        <input type="url" id="enlaceCompartir" class="input" placeholder="Pega aquÃ­ el enlace que quieres compartir (YouTube, TikTok, IG, FB...)">
                        <textarea id="mensajeEnlace" class="textarea" placeholder="Mensaje opcional para acompaÃ±ar el enlace...">Mira esto que estÃ¡ buenÃ­simo! 

ğŸ“± 809-713-5307</textarea>
                        <button class="btn btn-whatsapp" onclick="compartirEnlace()">ğŸ“± Compartir Enlace</button>
                    </div>

                    <div class="card">
                        <h3>ğŸ“ Templates RÃ¡pidos</h3>
                        <button class="btn btn-whatsapp" onclick="enviarTemplate('oferta1')">ğŸ Oferta 30%</button>
                        <button class="btn btn-whatsapp" onclick="enviarTemplate('oferta2')">ğŸ‘“ 2x1 Lentes</button>
                        <button class="btn btn-whatsapp" onclick="enviarTemplate('nuevo')">âœ¨ Nuevo Producto</button>
                        <button class="btn btn-whatsapp" onclick="enviarTemplate('cita')">ğŸ‘ï¸ Agendar Cita</button>
                        
                        <h4 style="margin-top: 20px;">ğŸ“ Mensaje Personalizado</h4>
                        <textarea id="templatePersonal" class="textarea" placeholder="Crear mensaje personalizado..."></textarea>
                        <button class="btn btn-success" onclick="enviarTemplatePersonal()">ğŸ“± Enviar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTARIO -->
        <div id="inventario" class="section">
            <h2>ğŸ“¦ Inventario y CatÃ¡logo</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>ğŸ“· Agregar Producto al CatÃ¡logo</h3>
                <div class="camera-box" id="cameraBoxInventario">
                    <div id="placeholderInventario">
                        <div style="font-size: 50px;">ğŸ“·</div>
                        <div>Foto del producto</div>
                    </div>
                    <video id="videoInventario" style="display: none; width: 100%; height: 100%;" autoplay></video>
                </div>
                <button class="btn btn-primary" onclick="toggleCameraInventario()" id="cameraBtnInventario">ğŸ“· Tomar Foto</button>
                <img id="previewInventario" style="display: none; width: 100%; margin: 10px 0; border-radius: 5px;">
                
                <input type="text" id="codigoProducto" class="input" placeholder="CÃ³digo (ej: UV001)">
                <input type="text" id="nombreProducto" class="input" placeholder="Nombre del producto">
                <input type="number" id="precioProducto" class="input" placeholder="Precio RD$">
                
                <button class="btn btn-success" onclick="guardarProducto()">ğŸ’¾ Guardar en CatÃ¡logo</button>
                <button class="btn btn-whatsapp" onclick="guardarYCompartir()">ğŸ“± Guardar y Compartir</button>
            </div>
            
            <div class="card">
                <h3>ğŸ“‹ CatÃ¡logo de Productos</h3>
                <input type="text" class="input" placeholder="ğŸ” Buscar producto..." onkeyup="buscarProducto(this.value)">
                <div id="listaProductos"></div>
            </div>
        </div>

        <!-- MÃ“DULO NOTICIAS -->
        <div id="noticias" class="section">
            <h2>ğŸ“° InfoFlash - Noticias Variadas</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>ğŸ”— Compartir Noticia/Enlace</h3>
                <input type="url" id="enlaceNoticia" class="input" placeholder="Pega aquÃ­ el enlace de la noticia que quieres compartir">
                <textarea id="mensajeNoticia" class="textarea" placeholder="Mensaje para la noticia...">ğŸ“° Mira esta noticia interesante:

ğŸ“± 809-713-5307</textarea>
                <button class="btn btn-whatsapp" onclick="compartirEnlaceNoticia()">ğŸ“± Compartir Noticia</button>
            </div>
            
            <div class="card">
                <button class="btn btn-primary" onclick="cargarNoticias()">ğŸ”„ Actualizar Noticias</button>
                <p style="color: #94a3b8; margin: 10px 0;">FarÃ¡ndula, Noticias RD y Curiosidades Globales para compartir</p>
            </div>
            
            <div id="listaNoticasContainer"></div>
        </div>

        <!-- CLIENTES -->
        <div id="clientes" class="section">
            <h2>ğŸ‘¥ Base de Clientes</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>â• Agregar Cliente</h3>
                <input type="text" id="nombreCliente" class="input" placeholder="Nombre completo">
                <input type="tel" id="telefonoCliente" class="input" placeholder="TelÃ©fono (809-XXX-XXXX)">
                <button class="btn btn-success" onclick="agregarCliente()">ğŸ‘¥ Agregar Cliente</button>
            </div>
            
            <div class="card">
                <h3>ğŸ“‹ Lista de Clientes</h3>
                <div id="listaClientes"></div>
            </div>
        </div>

        <!-- ========================================
             ğŸ“Š MÃ“DULO REPORTES COMPLETOS
             ======================================== -->
        <div id="reportes" class="section">
            <h2>ğŸ“Š Reportes del Negocio</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="grid">
                <div class="card">
                    <h3>ğŸ’° Resumen Financiero</h3>
                    <div class="stat-box">
                        <div class="stat-number" style="color: #10b981;" id="totalVentas">RD$ 0</div>
                        <div>Total Ventas</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" style="color: #f59e0b;" id="totalPorCobrar">RD$ 0</div>
                        <div>Por Cobrar</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" style="color: #ef4444;" id="totalPorPagar">RD$ 0</div>
                        <div>Por Pagar (Labs)</div>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ”¬ Estado Laboratorio</h3>
                    <div class="stat-box">
                        <div class="stat-number" style="color: #7c3aed;" id="ordenesEnProceso">0</div>
                        <div>En Proceso</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" style="color: #059669;" id="ordenesListas">0</div>
                        <div>Listas</div>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ“ˆ Ventas Recientes</h3>
                    <div id="ventasRecientes"></div>
                    <button class="btn btn-primary" onclick="nuevaVenta()">ğŸ’° Registrar Venta</button>
                </div>
            </div>
        </div>

        <!-- CUENTAS POR COBRAR -->
        <div id="cuentas" class="section">
            <h2>ğŸ’µ Cuentas por Cobrar</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>ğŸ“‹ Clientes que Deben Dinero</h3>
                <div id="listaCuentasPorCobrar"></div>
            </div>
            
            <div class="card">
                <h3>ğŸ’° Registrar Abono</h3>
                <select id="clienteAbono" class="select">
                    <option value="">Seleccionar cliente existente</option>
                </select>
                
                <div style="margin: 15px 0; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <label style="font-weight: bold;">O escriba nombre de cliente nuevo (se guardarÃ¡ automÃ¡ticamente):</label>
                    <input type="text" id="clienteManualAbono" class="input" placeholder="Nombre del cliente que viene a abonar">
                </div>
                
                <input type="number" id="montoAbono" class="input" placeholder="Monto del abono RD$">
                <input type="text" id="conceptoAbono" class="input" placeholder="Concepto del abono (ej: Abono lentes progresivos)">
                <button class="btn btn-success" onclick="registrarAbono()">ğŸ’° Registrar Abono</button>
            </div>
        </div>

        <!-- CUENTAS POR PAGAR -->
        <div id="deudas" class="section">
            <h2>ğŸ“‹ Cuentas por Pagar (Laboratorios)</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>ğŸ­ Lo que Debo a Laboratorios</h3>
                <div id="listaCuentasPorPagar"></div>
            </div>
            
            <div class="card">
                <h3>ğŸ’³ Pagar a Laboratorio</h3>
                <input type="text" id="laboratorioManualPago" class="input" placeholder="Nombre del laboratorio" list="laboratoriosDatalist">
                <datalist id="laboratoriosDatalist">
                    <!-- Se llena automÃ¡ticamente con laboratorios usados -->
                </datalist>
                <input type="number" id="montoPago" class="input" placeholder="Monto del pago RD$">
                <button class="btn btn-success" onclick="pagarLaboratorio()">ğŸ’³ Registrar Pago</button>
            </div>
        </div>

        <!-- ========================================
             ğŸ“„ MÃ“DULO FACTURACIÃ“N CON NCF
             ======================================== -->
        <div id="facturacion" class="section">
            <h2>ğŸ“„ Sistema de FacturaciÃ³n</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">â¬…ï¸ Volver</button>
            
            <div class="card">
                <h3>ğŸ“‹ Nueva Factura/Proforma</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>ğŸ‘¤ Cliente:</label>
                        <input type="text" id="clienteManualFactura" class="input" placeholder="Escriba nombre del cliente (se guardarÃ¡ automÃ¡ticamente)" list="clientesDatalist">
                        <datalist id="clientesDatalist">
                            <!-- Se llena automÃ¡ticamente -->
                        </datalist>
                    </div>
                    <div>
                        <label>ğŸ”¢ Tipo Comprobante:</label>
                        <select id="tipoComprobante" class="select" onchange="generarNCF()">
                            <option value="">Seleccionar tipo</option>
                            <option value="B01">B01 - Factura CrÃ©dito Fiscal</option>
                            <option value="B02">B02 - Factura Consumidor Final</option>
                            <option value="B14">B14 - Factura RÃ©gimen Especial</option>
                            <option value="B15">B15 - Factura Gubernamental</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <div>
                        <label>ğŸ“„ NCF (NÃºmero Comprobante Fiscal):</label>
                        <input type="text" id="ncfFactura" class="input" placeholder="Se genera automÃ¡ticamente" readonly style="background: #f5f5f5;">
                    </div>
                    <div>
                        <label>ğŸ“… Fecha:</label>
                        <input type="date" id="fechaFactura" class="input">
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <label>ğŸ“ DescripciÃ³n del Producto/Servicio:</label>
                    <textarea id="descripcionFactura" class="textarea" placeholder="Ej: Lentes progresivos con montura titanio, examen de vista incluido..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>ğŸ’° Subtotal:</label>
                        <input type="number" id="subtotalFactura" class="input" placeholder="0.00" oninput="calcularTotales()">
                    </div>
                    <div>
                        <label>ğŸ“Š ITBIS (18%):</label>
                        <input type="number" id="itbisFactura" class="input" placeholder="0.00" readonly style="background: #f5f5f5;">
                    </div>
                    <div>
                        <label>ğŸ’µ TOTAL:</label>
                        <input type="number" id="totalFactura" class="input" placeholder="0.00" readonly style="background: #f5f5f5; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>ğŸ’³ Abono Inicial:</label>
                        <input type="number" id="abonoFactura" class="input" placeholder="0.00" oninput="calcularSaldo()">
                    </div>
                    <div>
                        <label>ğŸ“‹ Saldo Pendiente:</label>
                        <input type="number" id="saldoFactura" class="input" placeholder="0.00" readonly style="background: #fff3cd; font-weight: bold;">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="generarFactura()" style="font-size: 16px; padding: 15px 30px;">ğŸ“„ Generar Factura</button>
                    <button class="btn btn-whatsapp" onclick="enviarFacturaPorWhatsApp()">ğŸ“± Enviar por WhatsApp</button>
                    <button class="btn btn-warning" onclick="imprimirFactura()">ğŸ–¨ï¸ Imprimir</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“‹ Facturas Recientes</h3>
                <div id="listaFacturasRecientes"></div>
            </div>
        </div>
    </div>

    <div class="alert" id="alert"></div>
    
    <div style="position: fixed; bottom: 5px; right: 10px; font-size: 10px; color: rgba(255,255,255,0.6);">
        Sistema v5.0 con Marketing Intelligence | by fbrugal jrubinstein consultores
    </div>

    <script>
        // ========================================
        // ğŸ”§ VARIABLES GLOBALES
        // ========================================
        let productos = [];
        let clientes = [];
        let ordenesLab = [];
        let noticias = [];
        let ventas = [];
        let facturas = [];
        let cuentasPorCobrar = [];
        let cuentasPorPagar = [];
        
        // Contadores para NCF
        let contadorNCF = {
            'B01': 1,
            'B02': 1, 
            'B14': 1,
            'B15': 1
        };
        
        // Archivo subido desde mÃ³vil
        let archivoMovilSubido = null;
        
        // Streams de cÃ¡mara separados
        let streamReceta = null;
        let streamMontura = null;
        let streamPromo = null;
        let streamInventario = null;
        
        // Fotos capturadas
        let fotoReceta = null;
        let fotoMontura = null;
        let fotoPromo = null;
        let fotoInventario = null;

        // Variables de audio
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let startTime;
        let timerInterval;

        // ========================================
        // ğŸš€ INICIALIZACIÃ“N
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            actualizarDashboard();
            
            // Actualizar datalists al cargar
            actualizarDatalistClientes();
            actualizarDatalistLaboratorios();
            
            // Auto-actualizar noticias cada 10 minutos
            cargarNoticias();
            setInterval(cargarNoticias, 10 * 60 * 1000);
            
            // Simular backup automÃ¡tico
            setInterval(actualizarBackupStatus, 30000);
            
            showAlert('âœ… Sistema Urbana Vision v5.0 + Marketing Intelligence iniciado');
        });

        function cargarDatos() {
            try {
                productos = JSON.parse(localStorage.getItem('urbana_productos') || '[]');
                clientes = JSON.parse(localStorage.getItem('urbana_clientes') || '[]');
                ordenesLab = JSON.parse(localStorage.getItem('urbana_ordenes_lab') || '[]');
                noticias = JSON.parse(localStorage.getItem('urbana_noticias') || '[]');
                ventas = JSON.parse(localStorage.getItem('urbana_ventas') || '[]');
                facturas = JSON.parse(localStorage.getItem('urbana_facturas') || '[]');
                cuentasPorCobrar = JSON.parse(localStorage.getItem('urbana_cuentas_cobrar') || '[]');
                cuentasPorPagar = JSON.parse(localStorage.getItem('urbana_cuentas_pagar') || '[]');
                contadorNCF = JSON.parse(localStorage.getItem('urbana_contador_ncf') || '{"B01": 1, "B02": 1, "B14": 1, "B15": 1}');
                
                // Datos de ejemplo si estÃ¡n vacÃ­os
                if (clientes.length === 0) {
                    clientes = [
                        { id: 1, nombre: 'MarÃ­a GonzÃ¡lez', telefono: '809-555-0001', cedula: '001-1234567-8' },
                        { id: 2, nombre: 'Juan PÃ©rez', telefono: '809-555-0002', cedula: '001-2345678-9' }
                    ];
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        function guardarDatos() {
            try {
                localStorage.setItem('urbana_productos', JSON.stringify(productos));
                localStorage.setItem('urbana_clientes', JSON.stringify(clientes));
                localStorage.setItem('urbana_ordenes_lab', JSON.stringify(ordenesLab));
                localStorage.setItem('urbana_noticias', JSON.stringify(noticias));
                localStorage.setItem('urbana_ventas', JSON.stringify(ventas));
                localStorage.setItem('urbana_facturas', JSON.stringify(facturas));
                localStorage.setItem('urbana_cuentas_cobrar', JSON.stringify(cuentasPorCobrar));
                localStorage.setItem('urbana_cuentas_pagar', JSON.stringify(cuentasPorPagar));
                localStorage.setItem('urbana_contador_ncf', JSON.stringify(contadorNCF));

                // Simular backup a Netlify
                enviarBackupNetlify();
            } catch (error) {
                console.error('Error guardando datos:', error);
            }
        }

        function enviarBackupNetlify() {
            // Simular envÃ­o de backup a Netlify
            console.log('ğŸ“¡ Enviando backup a Netlify...');
            setTimeout(() => {
                showAlert('â˜ï¸ Backup automÃ¡tico enviado a Netlify');
            }, 1000);
        }

        function actualizarBackupStatus() {
            const ahora = new Date();
            const ultimoBackup = new Date(ahora.getTime() - Math.random() * 7200000); // Ãšltimas 2 horas
            const diferencia = Math.floor((ahora - ultimoBackup) / 60000); // en minutos
            
            document.getElementById('ultimoBackup').textContent = 
                diferencia < 60 ? `Hace ${diferencia} min` : `Hace ${Math.floor(diferencia/60)} horas`;
        }

        // ========================================
        // ğŸ”„ NAVEGACIÃ“N
        // ========================================
        function mostrar(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Mostrar la secciÃ³n solicitada
            const elemento = document.getElementById(seccion);
            if (elemento) {
                elemento.classList.add('active');
            }
            
            // Ejecutar funciones especÃ­ficas segÃºn la secciÃ³n
            switch(seccion) {
                case 'menu': 
                    actualizarDashboard(); 
                    break;
                case 'inventario': 
                    cargarInventario(); 
                    break;
                case 'ordenes': 
                    cargarOrdenesLab(); 
                    break;
                case 'clientes': 
                    cargarClientes(); 
                    break;
                case 'noticias': 
                    cargarNoticias(); 
                    break;
                case 'reportes': 
                    cargarReportes(); 
                    break;
                case 'facturacion': 
                    cargarFacturacion(); 
                    break;
                case 'cuentas': 
                    cargarCuentasPorCobrar(); 
                    break;
                case 'deudas': 
                    cargarCuentasPorPagar(); 
                    break;
            }
        }

        function showAlert(msg) {
            const alert = document.getElementById('alert');
            if (alert) {
                alert.textContent = msg;
                alert.style.display = 'block';
                setTimeout(() => alert.style.display = 'none', 4000);
            }
        }

        function actualizarDashboard() {
            const totalProductosEl = document.getElementById('totalProductos');
            const totalOrdenesEl = document.getElementById('totalOrdenes');
            const totalClientesEl = document.getElementById('totalClientes');
            
            if (totalProductosEl) totalProductosEl.textContent = productos.length;
            if (totalOrdenesEl) totalOrdenesEl.textContent = ordenesLab.length;
            if (totalClientesEl) totalClientesEl.textContent = clientes.length;
        }

        function backup() {
            showAlert('ğŸ’¾ Backup manual iniciado...');
            setTimeout(() => {
                guardarDatos();
                showAlert('âœ… Backup completado y enviado a Netlify');
            }, 2000);
        }

        // ========================================
        // ğŸ‘¥ FUNCIONES DE AUTO-GUARDADO DE CLIENTES
        // ========================================
        function autoGuardarCliente(nombre, telefono = '') {
            const clienteExistente = clientes.find(c => c.nombre.toLowerCase() === nombre.toLowerCase());
            if (clienteExistente) {
                return clienteExistente.id;
            }
            
            const nuevoCliente = {
                id: Date.now(),
                nombre: nombre.trim(),
                telefono: telefono.trim(),
                cedula: '',
                fecha: new Date().toISOString(),
                autoCreado: true
            };
            
            clientes.push(nuevoCliente);
            guardarDatos();
            actualizarDatalistClientes();
            
            showAlert(`ğŸ‘¥ Cliente "${nombre}" guardado automÃ¡ticamente`);
            return nuevoCliente.id;
        }

        function actualizarDatalistClientes() {
            const datalists = ['clientesDatalist', 'clientesDatalistLab'];
            datalists.forEach(datalistId => {
                const datalist = document.getElementById(datalistId);
                if (datalist) {
                    datalist.innerHTML = clientes.map(c => `<option value="${c.nombre}"></option>`).join('');
                }
            });
        }

        function actualizarDatalistLaboratorios() {
            const laboratoriosUsados = [...new Set([
                ...ordenesLab.map(o => o.laboratorio).filter(Boolean),
                ...cuentasPorPagar.map(p => p.laboratorio).filter(Boolean)
            ])];
            
            const datalists = ['laboratoriosDatalist', 'laboratoriosDatalistLab'];
            datalists.forEach(datalistId => {
                const datalist = document.getElementById(datalistId);
                if (datalist) {
                    datalist.innerHTML = laboratoriosUsados.map(lab => `<option value="${lab}"></option>`).join('');
                }
            });
        }

        // ========================================
        // ğŸ¤ FUNCIONES DE AUDIO MARKETING
        // ========================================
        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayback').src = audioUrl;
                    document.getElementById('audioPlayback').style.display = 'block';
                    
                    // Simular conversiÃ³n de voz a texto
                    setTimeout(() => {
                        const textosEjemplo = [
                            "Â¡Klk! Tengo una promociÃ³n brutal para ti. 30% de descuento en todas las monturas. Eso tÃ¡ bueno, Â¿verdad?",
                            "Â¡Eyyy! Â¿CÃ³mo tÃº tÃ¡? Mira, llegaron unos lentes nuevos que estÃ¡n divinos. Te van a quedar perfectos.",
                            "Â¡Dale! Que tengo algo que te va a gustar. Lentes progresivos con descuento especial. Vamos a hablar."
                        ];
                        document.getElementById('textoConvertido').textContent = 
                            textosEjemplo[Math.floor(Math.random() * textosEjemplo.length)];
                    }, 2000);
                };
                
                mediaRecorder.start();
                isRecording = true;
                startTime = Date.now();
                
                document.getElementById('recordBtn').className = 'record-btn recording';
                document.getElementById('estadoGrabacion').textContent = 'Grabando...';
                
                // Timer
                timerInterval = setInterval(updateTimer, 1000);
                
            } catch (error) {
                showAlert('âŒ Error al acceder al micrÃ³fono');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                document.getElementById('recordBtn').className = 'record-btn';
                document.getElementById('estadoGrabacion').textContent = 'Audio grabado âœ…';
                
                clearInterval(timerInterval);
            }
        }
        
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('tiempoGrabacion').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function enviarAudio() {
            const texto = document.getElementById('textoConvertido').textContent;
            if (texto.includes('Tu voz se convertirÃ¡')) {
                showAlert('âŒ Grabe un audio primero');
                return;
            }
            
            const mensaje = `ğŸ¤ AUDIO URBANA VISION:\n\nğŸ“ ${texto}\n\nğŸ“± 809-713-5307`;
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Audio y texto enviados');
        }

        // ========================================
        // ğŸ¨ FUNCIONES DE TEMPLATES
        // ========================================
        function crearTemplateWhatsApp() {
            mostrarTemplate('ğŸ“± WHATSAPP', `ğŸ”¥ Â¡OFERTAS QUE ESTÃN BRUTAL!

ğŸ‘“ Monturas de diseÃ±ador
ğŸ’° Precios que no vas a creer
âœ¨ Calidad garantizada

Â¿CuÃ¡l te gusta mÃ¡s? ğŸ‘‡

ğŸ“± 809-713-5307
ğŸ“ Urbana Vision - Donde ves mejor`);
        }
        
        function crearTemplateInstagram() {
            mostrarTemplate('ğŸ“· INSTAGRAM', `âœ¨ New collection just dropped âœ¨

ğŸ‘“ Premium frames
ğŸ”¥ Dominican style
ğŸ’ Quality you can trust

#UrbanaVision #DominicanStyle #PremiumEyewear

ğŸ“± 809-713-5307`);
        }
        
        function crearTemplateTikTok() {
            mostrarTemplate('ğŸµ TIKTOK', `POV: Cuando encuentras los lentes perfectos ğŸ˜

âœ… Style âœ… Quality âœ… Price

@urbanavision tiene lo que buscas ğŸ‘€

#lentes #moda #rd #viral #fyp`);
        }
        
        function crearTemplateFacebook() {
            mostrarTemplate('ğŸ“˜ FACEBOOK MARKETPLACE', `ğŸ‘“ LENTES PREMIUM - NUEVOS

ğŸ”¹ Monturas de diseÃ±ador
ğŸ”¹ Lentes con garantÃ­a  
ğŸ”¹ Ajuste profesional incluido
ğŸ”¹ Precio: RD$ [PRECIO]

ğŸ“± WhatsApp: 809-713-5307
ğŸ“ UbicaciÃ³n: [TU DIRECCIÃ“N]

#Lentes #Optica #SantoDomingo`);
        }
        
        function mostrarTemplate(plataforma, contenido) {
            document.getElementById('templateGenerado').style.display = 'block';
            document.getElementById('contenidoTemplate').innerHTML = `
                <h4>${plataforma}</h4>
                <div style="white-space: pre-line; margin: 10px 0;">
${contenido}
                </div>
            `;
        }
        
        function enviarTemplate() {
            const contenido = document.getElementById('contenidoTemplate').textContent;
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(contenido)}`, '_blank');
            showAlert('ğŸ“± Template enviado por WhatsApp');
        }

        // ========================================
        // ğŸ¤– FUNCIONES DE IA
        // ========================================
        function aplicarTonoDominicano() {
            const mensajes = [
                "Â¡Klk loco! Estos lentes estÃ¡n brutal, Â¿tÃº no crees? ğŸ‘“âœ¨",
                "Â¡Ey manito! Mira estos lentes que llegaron, estÃ¡n divinos ğŸ˜",
                "Â¡Dale que vamo a ve! Tengo una oferta que tÃ¡ buena ğŸ”¥"
            ];
            const mensaje = mensajes[Math.floor(Math.random() * mensajes.length)];
            document.getElementById('textoConvertido').textContent = mensaje;
            showAlert('ğŸ‡©ğŸ‡´ Tono dominicano aplicado');
        }
        
        function crearVideoOptimizado() {
            showAlert('ğŸ¥ Creando video optimizado para domingo 7-9 PM...');
        }
        
        function crearVideoRapido() {
            showAlert('ğŸ¥ Video rÃ¡pido de 15 segundos con mÃºsica dominicana');
        }
        
        function programarContenido() {
            showAlert('ğŸ“… Programando Stories para 6-8 AM y 6-8 PM');
        }

        // ========================================
        // ğŸ“· FUNCIONES DE CÃMARA (SEPARADAS)
        // ========================================
        
        // CÃ¡mara para RECETA
        async function toggleCameraReceta() {
            const video = document.getElementById('videoReceta');
            const btn = document.getElementById('cameraBtnReceta');
            const placeholder = document.getElementById('placeholderReceta');
            
            if (!streamReceta) {
                try {
                    streamReceta = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = streamReceta;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.textContent = 'ğŸ“¸ Capturar Receta';
                    btn.onclick = tomarFotoReceta;
                } catch (err) {
                    showAlert('âŒ Error al acceder a la cÃ¡mara');
                }
            } else {
                tomarFotoReceta();
            }
        }

        function tomarFotoReceta() {
            const video = document.getElementById('videoReceta');
            const preview = document.getElementById('previewReceta');
            const btn = document.getElementById('cameraBtnReceta');
            const placeholder = document.getElementById('placeholderReceta');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            fotoReceta = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = fotoReceta;
            preview.style.display = 'block';
            
            // Detener cÃ¡mara
            streamReceta.getTracks().forEach(track => track.stop());
            streamReceta = null;
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            btn.textContent = 'ğŸ“¸ Tomar Foto Receta';
            btn.onclick = toggleCameraReceta;
            
            showAlert('ğŸ“¸ Foto de receta capturada - guardado automÃ¡tico');
        }

        // CÃ¡mara para MONTURA
        async function toggleCameraMontura() {
            const video = document.getElementById('videoMontura');
            const btn = document.getElementById('cameraBtnMontura');
            const placeholder = document.getElementById('placeholderMontura');
            
            if (!streamMontura) {
                try {
                    streamMontura = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = streamMontura;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.textContent = 'ğŸ“¸ Capturar Montura';
                    btn.onclick = tomarFotoMontura;
                } catch (err) {
                    showAlert('âŒ Error al acceder a la cÃ¡mara');
                }
            } else {
                tomarFotoMontura();
            }
        }

        function tomarFotoMontura() {
            const video = document.getElementById('videoMontura');
            const preview = document.getElementById('previewMontura');
            const btn = document.getElementById('cameraBtnMontura');
            const placeholder = document.getElementById('placeholderMontura');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            fotoMontura = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = fotoMontura;
            preview.style.display = 'block';
            
            // Detener cÃ¡mara
            streamMontura.getTracks().forEach(track => track.stop());
            streamMontura = null;
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            btn.textContent = 'ğŸ“¸ Tomar Foto Montura';
            btn.onclick = toggleCameraMontura;
            
            showAlert('ğŸ“¸ Foto de montura capturada - guardado automÃ¡tico');
        }

        // CÃ¡mara para PROMOCIONES
        async function toggleCameraPromo() {
            const video = document.getElementById('videoPromo');
            const btn = document.getElementById('cameraBtnPromo');
            const placeholder = document.getElementById('placeholderPromo');
            
            if (!streamPromo) {
                try {
                    streamPromo = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = streamPromo;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.textContent = 'ğŸ“¸ Capturar';
                    btn.onclick = tomarFotoPromo;
                } catch (err) {
                    showAlert('âŒ Error al acceder a la cÃ¡mara');
                }
            } else {
                tomarFotoPromo();
            }
        }

        function tomarFotoPromo() {
            const video = document.getElementById('videoPromo');
            const preview = document.getElementById('previewPromo');
            const btn = document.getElementById('cameraBtnPromo');
            const placeholder = document.getElementById('placeholderPromo');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            fotoPromo = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = fotoPromo;
            preview.style.display = 'block';
            
            // Detener cÃ¡mara
            streamPromo.getTracks().forEach(track => track.stop());
            streamPromo = null;
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            btn.textContent = 'ğŸ“¸ Tomar Foto';
            btn.onclick = toggleCameraPromo;
            
            showAlert('ğŸ“¸ Foto promocional capturada');
        }

        // CÃ¡mara para INVENTARIO
        async function toggleCameraInventario() {
            const video = document.getElementById('videoInventario');
            const btn = document.getElementById('cameraBtnInventario');
            const placeholder = document.getElementById('placeholderInventario');
            
            if (!streamInventario) {
                try {
                    streamInventario = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = streamInventario;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.textContent = 'ğŸ“· Capturar';
                    btn.onclick = tomarFotoInventario;
                } catch (err) {
                    showAlert('âŒ Error al acceder a la cÃ¡mara');
                }
            } else {
                tomarFotoInventario();
            }
        }

        function tomarFotoInventario() {
            const video = document.getElementById('videoInventario');
            const preview = document.getElementById('previewInventario');
            const btn = document.getElementById('cameraBtnInventario');
            const placeholder = document.getElementById('placeholderInventario');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            fotoInventario = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = fotoInventario;
            preview.style.display = 'block';
            
            // Detener cÃ¡mara
            streamInventario.getTracks().forEach(track => track.stop());
            streamInventario = null;
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            btn.textContent = 'ğŸ“· Tomar Foto';
            btn.onclick = toggleCameraInventario;
            
            showAlert('ğŸ“· Foto de producto capturada');
        }

        // ========================================
        // ğŸ”¬ FUNCIONES DE LABORATORIO ACTUALIZADAS
        // ========================================
        function enviarOrdenLaboratorio() {
            // Obtener graduaciÃ³n completa
            const esferaOD = document.getElementById('esferaOD').value;
            const cilindroOD = document.getElementById('cilindroOD').value;
            const ejeOD = document.getElementById('ejeOD').value;
            const esferaOI = document.getElementById('esferaOI').value;
            const cilindroOI = document.getElementById('cilindroOI').value;
            const ejeOI = document.getElementById('ejeOI').value;
            const add = document.getElementById('addLente').value;
            
            // Datos del cliente y venta
            const clienteNombre = document.getElementById('clienteLaboratorio').value.trim();
            const precioVenta = parseFloat(document.getElementById('precioVentaLab').value) || 0;
            const laboratorioNombre = document.getElementById('laboratorioNombre').value.trim();
            
            // Otros datos tÃ©cnicos
            const dp = document.getElementById('distanciaPupilar').value;
            const altura = document.getElementById('alturaLente').value;
            const tipo = document.getElementById('tipoLente').value;
            const material = document.getElementById('materialLente').value;
            const costo = document.getElementById('costoLab').value;
            
            // Validaciones CRÃTICAS
            if (!fotoReceta) {
                showAlert('âŒ Tome foto de la receta (PASO 1)');
                return;
            }
            if (!fotoMontura) {
                showAlert('âŒ Tome foto de la montura (PASO 2)');
                return;
            }
            if (!clienteNombre) {
                showAlert('âŒ Ingrese nombre del cliente');
                return;
            }
            if (!laboratorioNombre) {
                showAlert('âŒ Ingrese nombre del laboratorio');
                return;
            }
            if (!esferaOD || !esferaOI) {
                showAlert('âŒ Complete la graduaciÃ³n OD y OI (esfera obligatoria)');
                return;
            }
            if (!dp || !altura || !tipo || !material || !costo) {
                showAlert('âŒ Complete todos los datos tÃ©cnicos');
                return;
            }
            if (precioVenta <= 0) {
                showAlert('âŒ Ingrese precio de venta al cliente');
                return;
            }
            
            // Auto-guardar cliente si no existe
            const clienteId = autoGuardarCliente(clienteNombre);
            
            // Crear orden CON graduaciÃ³n completa
            const orden = {
                id: Date.now(),
                numero: 'UV-' + Date.now().toString().slice(-6),
                clienteId: clienteId,
                clienteNombre: clienteNombre,
                precioVenta: precioVenta,
                laboratorio: laboratorioNombre,
                graduacion: {
                    od: {
                        esfera: esferaOD,
                        cilindro: cilindroOD || '',
                        eje: ejeOD || ''
                    },
                    oi: {
                        esfera: esferaOI,
                        cilindro: cilindroOI || '',
                        eje: ejeOI || ''
                    },
                    add: add || ''
                },
                dp: dp,
                altura: altura,
                tipo: tipo,
                material: material,
                costo: parseFloat(costo),
                fotoReceta: fotoReceta,
                fotoMontura: fotoMontura,
                fecha: new Date().toISOString(),
                estado: 'enviado'
            };
            
            // Mensaje COMPLETO para laboratorio
            const mensaje = `ğŸ”¬ ORDEN LABORATORIO URBANA VISION

ğŸ“‹ Orden: ${orden.numero}
ğŸ“… ${new Date().toLocaleDateString()}
ğŸ­ Para: ${laboratorioNombre}

ğŸ‘¤ CLIENTE: ${clienteNombre}

ğŸ‘ï¸ GRADUACIÃ“N OJO DERECHO (OD):
â€¢ Esfera: ${esferaOD}
â€¢ Cilindro: ${cilindroOD || 'N/A'}
â€¢ Eje: ${ejeOD || 'N/A'}Â°

ğŸ‘ï¸ GRADUACIÃ“N OJO IZQUIERDO (OI):  
â€¢ Esfera: ${esferaOI}
â€¢ Cilindro: ${cilindroOI || 'N/A'}
â€¢ Eje: ${ejeOI || 'N/A'}Â°

${add ? `â• ADD: ${add}` : ''}

ğŸ“ DATOS TÃ‰CNICOS:
â€¢ DP: ${dp} mm
â€¢ Altura lente: ${altura} mm  
â€¢ Tipo: ${tipo}
â€¢ Material: ${material}

ğŸ’° COSTO LAB: RD$ ${costo}

ğŸ“¸ FOTOS ADJUNTAS:
â€¢ Receta mÃ©dica completa
â€¢ Montura seleccionada

ğŸ¢ Urbana Vision
ğŸ“± 809-713-5307

âš ï¸ CONFIRMAR RECEPCIÃ“N Y TIEMPO DE ENTREGA`;
            
            // Enviar por WhatsApp
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            
            // Guardar orden
            ordenesLab.push(orden);
            guardarDatos();
            actualizarDatalistLaboratorios();
            limpiarFormularioLab();
            
            showAlert('ğŸ“± Orden COMPLETA enviada al laboratorio');
        }

        function limpiarFormularioLab() {
            // Limpiar graduaciÃ³n
            document.getElementById('esferaOD').value = '';
            document.getElementById('cilindroOD').value = '';
            document.getElementById('ejeOD').value = '';
            document.getElementById('esferaOI').value = '';
            document.getElementById('cilindroOI').value = '';
            document.getElementById('ejeOI').value = '';
            document.getElementById('addLente').value = '';
            
            // Limpiar datos del cliente y venta
            document.getElementById('clienteLaboratorio').value = '';
            document.getElementById('precioVentaLab').value = '';
            document.getElementById('laboratorioNombre').value = '';
            
            // Limpiar otros datos
            document.getElementById('distanciaPupilar').value = '';
            document.getElementById('alturaLente').value = '';
            document.getElementById('tipoLente').value = '';
            document.getElementById('materialLente').value = '';
            document.getElementById('costoLab').value = '';
            
            // Limpiar fotos
            document.getElementById('previewReceta').style.display = 'none';
            document.getElementById('previewMontura').style.display = 'none';
            
            fotoReceta = null;
            fotoMontura = null;
        }

        function cargarOrdenesLab() {
            actualizarDatalistClientes();
            actualizarDatalistLaboratorios();
            
            const lista = document.getElementById('listaOrdenesLab');
            
            if (ordenesLab.length === 0) {
                lista.innerHTML = '<p style="text-align: center;">No hay Ã³rdenes de laboratorio</p>';
                return;
            }
            
            lista.innerHTML = ordenesLab.slice().reverse().map(orden => `
                <div class="orden-item">
                    <div style="flex: 1;">
                        <h4>ğŸ”¬ Orden ${orden.numero}</h4>
                        <p><strong>Cliente:</strong> ${orden.clienteNombre || 'No especificado'}</p>
                        <p><strong>Laboratorio:</strong> ${orden.laboratorio}</p>
                        <p><strong>GraduaciÃ³n OD:</strong> ${orden.graduacion?.od?.esfera || ''} ${orden.graduacion?.od?.cilindro || ''} ${orden.graduacion?.od?.eje ? 'x' + orden.graduacion.od.eje + 'Â°' : ''}</p>
                        <p><strong>GraduaciÃ³n OI:</strong> ${orden.graduacion?.oi?.esfera || ''} ${orden.graduacion?.oi?.cilindro || ''} ${orden.graduacion?.oi?.eje ? 'x' + orden.graduacion.oi.eje + 'Â°' : ''}</p>
                        <p><strong>DP:</strong> ${orden.dp}mm | <strong>Tipo:</strong> ${orden.tipo}</p>
                        <p><strong>Costo Lab:</strong> RD$ ${orden.costo.toFixed(2)} | <strong>Precio Venta:</strong> RD$ ${(orden.precioVenta || 0).toFixed(2)}</p>
                        <p><strong>Estado:</strong> ${orden.estado} | <strong>Fecha:</strong> ${new Date(orden.fecha).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <button class="btn btn-lab" onclick="reenviarOrden(${orden.id})">ğŸ“± Reenviar</button>
                        ${orden.estado === 'enviado' ? 
                            `<button class="btn btn-success" onclick="marcarEntregado(${orden.id})">ğŸ“¦ Marcar Entregado</button>` : 
                            `<button class="btn btn-warning" onclick="entregarCliente(${orden.id})">ğŸ’° Entregar a Cliente</button>`
                        }
                        <button class="btn btn-danger" onclick="eliminarOrden(${orden.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function marcarEntregado(id) {
            const orden = ordenesLab.find(o => o.id === id);
            if (!orden) return;
            
            orden.estado = 'entregado';
            orden.fechaEntrega = new Date().toISOString();
            
            guardarDatos();
            cargarOrdenesLab();
            showAlert('ğŸ“¦ Orden marcada como entregada por el laboratorio');
        }

        function entregarCliente(id) {
            const orden = ordenesLab.find(o => o.id === id);
            if (!orden) return;
            
            if (!orden.clienteNombre || !orden.precioVenta) {
                showAlert('âŒ Esta orden no tiene cliente o precio de venta especificado');
                return;
            }
            
            // Crear cuenta por cobrar automÃ¡ticamente
            const cuentaCobrar = {
                id: Date.now(),
                ordenId: orden.id,
                cliente: orden.clienteNombre,
                descripcion: `Lentes ${orden.tipo} - Orden ${orden.numero}`,
                montoOriginal: orden.precioVenta,
                saldo: orden.precioVenta,
                fecha: new Date().toISOString()
            };
            
            cuentasPorCobrar.push(cuentaCobrar);
            
            // Marcar orden como entregada al cliente
            orden.estado = 'entregado_cliente';
            orden.fechaEntregaCliente = new Date().toISOString();
            
            guardarDatos();
            cargarOrdenesLab();
            
            showAlert(`ğŸ’° Orden entregada a ${orden.clienteNombre}. Cuenta por cobrar creada por RD$ ${orden.precioVenta.toFixed(2)}`);
        }

        function reenviarOrden(id) {
            const orden = ordenesLab.find(o => o.id === id);
            if (!orden) return;
            
            const mensaje = `ğŸ”¬ REENVÃO ORDEN ${orden.numero}

ğŸ‘¤ Cliente: ${orden.clienteNombre || 'No especificado'}
ğŸ­ Laboratorio: ${orden.laboratorio}
ğŸ“ DP: ${orden.dp}mm | Altura: ${orden.altura}mm
ğŸ” ${orden.tipo} - ${orden.material}
ğŸ’° Costo: RD$ ${orden.costo}

âš ï¸ CONFIRMAR RECEPCIÃ“N URGENTE
ğŸ“± 809-713-5307`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Orden reenviada');
        }

        function eliminarOrden(id) {
            if (confirm('Â¿Eliminar esta orden?')) {
                ordenesLab = ordenesLab.filter(o => o.id !== id);
                guardarDatos();
                cargarOrdenesLab();
                showAlert('âœ… Orden eliminada');
            }
        }

        // ========================================
        // ğŸ“± FUNCIONES DE MARKETING (SEPARADAS)
        // ========================================
        function enviarPromocion() {
            const mensaje = document.getElementById('mensajePromo').value;
            
            if (!mensaje.trim()) {
                showAlert('âŒ Escriba un mensaje promocional');
                return;
            }
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± PromociÃ³n enviada por WhatsApp');
        }

        function manejarArchivoMovil(input) {
            const archivo = input.files[0];
            if (!archivo) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                archivoMovilSubido = {
                    nombre: archivo.name,
                    tipo: archivo.type,
                    datos: e.target.result,
                    tamaÃ±o: archivo.size
                };
                
                const preview = document.getElementById('previewArchivoMovil');
                const esTipoVideo = archivo.type.startsWith('video/');
                
                if (esTipoVideo) {
                    preview.innerHTML = `
                        <div style="padding: 15px; background: rgba(37, 211, 102, 0.2); border-radius: 10px; margin: 10px 0;">
                            ğŸ¥ Video: ${archivo.name}
                            <div style="font-size: 12px; opacity: 0.7;">${(archivo.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    `;
                } else {
                    preview.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; margin: 10px 0;">
                        <div style="padding: 10px; background: rgba(37, 211, 102, 0.2); border-radius: 10px; font-size: 12px;">
                            ğŸ“· ${archivo.name} - ${(archivo.size / 1024 / 1024).toFixed(2)} MB
                        </div>
                    `;
                }
                
                showAlert('âœ… Archivo del mÃ³vil cargado correctamente');
            };
            reader.readAsDataURL(archivo);
        }

        function compartirArchivoMovil() {
            if (!archivoMovilSubido) {
                showAlert('âŒ Seleccione un archivo del mÃ³vil primero');
                return;
            }
            
            const mensaje = document.getElementById('mensajeArchivoMovil').value || 'Archivo de Urbana Vision';
            
            if (navigator.share) {
                const [header, data] = archivoMovilSubido.datos.split(',');
                const mimeType = header.match(/:(.*?);/)[1];
                const binaryString = atob(data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: mimeType });
                const file = new File([blob], archivoMovilSubido.nombre, { type: mimeType });
                
                navigator.share({
                    title: 'Archivo Urbana Vision',
                    text: mensaje,
                    files: [file]
                }).then(() => {
                    showAlert('ğŸ“ Archivo compartido por WhatsApp');
                    // Limpiar
                    document.getElementById('previewArchivoMovil').innerHTML = '';
                    document.getElementById('mensajeArchivoMovil').value = 'ğŸ“± Â¡Mira esto!\n\nTe va a encantar.\n\nğŸ“± 809-713-5307';
                    document.getElementById('archivoMovil').value = '';
                    archivoMovilSubido = null;
                }).catch(() => {
                    window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
                    showAlert('ğŸ“ Mensaje enviado (archivo como referencia)');
                });
            } else {
                window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
                showAlert('ğŸ“ Mensaje enviado (archivo como referencia)');
            }
        }

        function compartirEnlace() {
            const enlace = document.getElementById('enlaceCompartir').value.trim();
            const mensaje = document.getElementById('mensajeEnlace').value.trim();
            
            if (!enlace) {
                showAlert('âŒ Pegue un enlace para compartir');
                return;
            }
            
            const mensajeCompleto = mensaje ? `${mensaje}\n\n${enlace}` : enlace;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensajeCompleto)}`, '_blank');
            showAlert('ğŸ“± Enlace compartido por WhatsApp');
            
            // Limpiar campos
            document.getElementById('enlaceCompartir').value = '';
            document.getElementById('mensajeEnlace').value = 'Mira esto que estÃ¡ buenÃ­simo! \n\nğŸ“± 809-713-5307';
        }

        function enviarTemplate(tipo) {
            const templates = {
                oferta1: `ğŸ OFERTA ESPECIAL 30% OFF

âœ¨ En monturas seleccionadas
â° Solo por tiempo limitado  
ğŸ‘“ Calidad garantizada

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`,

                oferta2: `ğŸ‘“ PROMOCIÃ“N 2X1 EN LENTES

ğŸ’¥ Lleva 2 y paga 1
ğŸ¯ Lentes de contacto
âœ… Marcas reconocidas

ğŸ“± 809-713-5307`,

                nuevo: `âœ¨ NUEVO PRODUCTO

ğŸ†• Acabamos de recibir
ğŸ’ Ãšltima moda
ğŸ† Calidad premium

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`,

                cita: `ğŸ‘ï¸ EXAMEN DE VISTA GRATIS

ğŸ†“ Consulta gratuita
ğŸ“… Horarios disponibles
ğŸ‘¨â€âš•ï¸ Profesionales certificados

Â¿CuÃ¡ndo te viene bien?
ğŸ“± 809-713-5307`
            };
            
            const mensaje = templates[tipo];
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Template enviado');
        }

        function enviarTemplatePersonal() {
            const mensaje = document.getElementById('templatePersonal').value.trim();
            
            if (!mensaje) {
                showAlert('âŒ Escriba un mensaje');
                return;
            }
            
            const mensajeCompleto = `${mensaje}

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensajeCompleto)}`, '_blank');
            showAlert('ğŸ“± Mensaje personalizado enviado');
        }

        // ========================================
        // ğŸ“¦ FUNCIONES DE INVENTARIO
        // ========================================
        function guardarProducto() {
            const codigo = document.getElementById('codigoProducto').value.trim();
            const nombre = document.getElementById('nombreProducto').value.trim();
            const precio = parseFloat(document.getElementById('precioProducto').value) || 0;
            
            if (!codigo || !nombre || !fotoInventario) {
                showAlert('âŒ Complete todos los campos y tome foto');
                return;
            }
            
            if (productos.some(p => p.codigo === codigo)) {
                showAlert('âŒ El cÃ³digo ya existe');
                return;
            }
            
            const producto = {
                id: Date.now(),
                codigo: codigo,
                nombre: nombre,
                precio: precio,
                imagen: fotoInventario,
                fecha: new Date().toISOString()
            };
            
            productos.push(producto);
            guardarDatos();
            limpiarFormularioInventario();
            showAlert('âœ… Producto guardado en catÃ¡logo');
        }

        function guardarYCompartir() {
            guardarProducto();
            setTimeout(() => {
                if (productos.length > 0) {
                    const ultimoProducto = productos[productos.length - 1];
                    compartirProducto(ultimoProducto);
                }
            }, 500);
        }

        function compartirProducto(producto) {
            const mensaje = `ğŸ›ï¸ NUEVO PRODUCTO

ğŸ“¦ ${producto.nombre}
ğŸ”¢ CÃ³digo: ${producto.codigo}
ğŸ’° Precio: RD$ ${producto.precio.toFixed(2)}

âœ¨ Â¿Te interesa?

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Producto compartido');
        }

        function limpiarFormularioInventario() {
            document.getElementById('codigoProducto').value = '';
            document.getElementById('nombreProducto').value = '';
            document.getElementById('precioProducto').value = '';
            document.getElementById('previewInventario').style.display = 'none';
            fotoInventario = null;
        }

        function cargarInventario() {
            const lista = document.getElementById('listaProductos');
            
            if (productos.length === 0) {
                lista.innerHTML = '<p style="text-align: center;">No hay productos. Use la cÃ¡mara para agregar.</p>';
                return;
            }
            
            lista.innerHTML = productos.map(p => `
                <div class="producto-item">
                    <img src="${p.imagen}" class="producto-img" alt="${p.nombre}">
                    <div style="flex: 1;">
                        <h4>${p.nombre}</h4>
                        <p>CÃ³digo: ${p.codigo}</p>
                        <p>Precio: RD$ ${p.precio.toFixed(2)}</p>
                    </div>
                    <div>
                        <button class="btn btn-whatsapp" onclick="compartirProductoPorId(${p.id})">ğŸ“± Compartir</button>
                        <button class="btn btn-danger" onclick="eliminarProducto(${p.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function compartirProductoPorId(id) {
            const producto = productos.find(p => p.id === id);
            if (producto) {
                compartirProducto(producto);
            }
        }

        function eliminarProducto(id) {
            if (confirm('Â¿Eliminar este producto?')) {
                productos = productos.filter(p => p.id !== id);
                guardarDatos();
                cargarInventario();
                showAlert('âœ… Producto eliminado');
            }
        }

        function buscarProducto(termino) {
            const filtrados = productos.filter(p => 
                p.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                p.codigo.toLowerCase().includes(termino.toLowerCase())
            );
            
            const lista = document.getElementById('listaProductos');
            if (filtrados.length === 0 && termino.trim() !== '') {
                lista.innerHTML = '<p style="text-align: center;">No se encontraron productos</p>';
                return;
            }
            
            if (termino.trim() === '') {
                cargarInventario();
                return;
            }
            
            lista.innerHTML = filtrados.map(p => `
                <div class="producto-item">
                    <img src="${p.imagen}" class="producto-img" alt="${p.nombre}">
                    <div style="flex: 1;">
                        <h4>${p.nombre}</h4>
                        <p>CÃ³digo: ${p.codigo}</p>
                        <p>Precio: RD$ ${p.precio.toFixed(2)}</p>
                    </div>
                    <div>
                        <button class="btn btn-whatsapp" onclick="compartirProductoPorId(${p.id})">ğŸ“± Compartir</button>
                        <button class="btn btn-danger" onclick="eliminarProducto(${p.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // ğŸ“° FUNCIONES DE NOTICIAS (AUTO-ACTUALIZACIÃ“N)
        // ========================================
        function cargarNoticias() {
            // Noticias mundiales variadas (farÃ¡ndula, deportes, curiosidades, etc.)
            const noticiasVariadas = [
                {
                    id: 1,
                    titulo: "Taylor Swift bate rÃ©cord mundial con nueva gira",
                    resumen: "La cantante estadounidense supera todas las expectativas de ventas",
                    categoria: "FarÃ¡ndula Mundial"
                },
                {
                    id: 2,
                    titulo: "Shakira y Bizarrap lanzan nueva colaboraciÃ³n",
                    resumen: "El dÃºo vuelve a sorprender con ritmos Ãºnicos",
                    categoria: "FarÃ¡ndula"
                },
                {
                    id: 3,
                    titulo: "RD entre los destinos favoritos del Caribe",
                    resumen: "RepÃºblica Dominicana supera a Jamaica en turismo 2024",
                    categoria: "Noticias RD"
                },
                {
                    id: 4,
                    titulo: "Bad Bunny anuncia retiro temporal de la mÃºsica",
                    resumen: "El artista puertorriqueÃ±o sorprende con su decisiÃ³n",
                    categoria: "FarÃ¡ndula"
                },
                {
                    id: 5,
                    titulo: "Los delfines pueden reconocerse en el espejo",
                    resumen: "Estudio revela la increÃ­ble inteligencia de estos mamÃ­feros",
                    categoria: "Curiosidades"
                },
                {
                    id: 6,
                    titulo: "Lionel Messi podrÃ­a jugar hasta los 40 aÃ±os",
                    resumen: "El astro argentino no descarta extender su carrera",
                    categoria: "Deportes"
                },
                {
                    id: 7,
                    titulo: "Kim Kardashian lanza nueva lÃ­nea de belleza",
                    resumen: "La empresaria expande su imperio cosmÃ©tico",
                    categoria: "FarÃ¡ndula Mundial"
                },
                {
                    id: 8,
                    titulo: "Santiago inaugura metro moderno en RD",
                    resumen: "La segunda ciudad del paÃ­s estrena transporte pÃºblico",
                    categoria: "Noticias RD"
                },
                {
                    id: 9,
                    titulo: "Â¿SabÃ­as que los octopus tienen sangre azul?",
                    resumen: "Datos fascinantes del mundo marino que te sorprenderÃ¡n",
                    categoria: "Curiosidades"
                },
                {
                    id: 10,
                    titulo: "Cristiano Ronaldo alcanza mil millones de seguidores",
                    resumen: "El portuguÃ©s hace historia en redes sociales",
                    categoria: "Deportes"
                },
                {
                    id: 11,
                    titulo: "Jennifer LÃ³pez confirma nueva pelÃ­cula en Netflix",
                    resumen: "La actriz regresa a la pantalla con thriller psicolÃ³gico",
                    categoria: "FarÃ¡ndula Mundial"
                },
                {
                    id: 12,
                    titulo: "Punta Cana recibe premio internacional de turismo",
                    resumen: "Destino dominicano reconocido mundialmente",
                    categoria: "Noticias RD"
                },
                {
                    id: 13,
                    titulo: "Los gatos pueden ver en 6 dimensiones de color",
                    resumen: "Su visiÃ³n es mucho mÃ¡s compleja de lo que pensÃ¡bamos",
                    categoria: "Curiosidades"
                },
                {
                    id: 14,
                    titulo: "Drake rompe silencio sobre polÃ©mica reciente",
                    resumen: "El rapero canadiense habla en exclusiva",
                    categoria: "FarÃ¡ndula Mundial"
                },
                {
                    id: 15,
                    titulo: "Bitcoin alcanza nuevo mÃ¡ximo histÃ³rico",
                    resumen: "La criptomoneda supera todas las expectativas",
                    categoria: "Finanzas"
                }
            ];
            
            // Seleccionar noticias aleatorias para mostrar
            const noticiasSeleccionadas = noticiasVariadas.sort(() => 0.5 - Math.random()).slice(0, 8);
            noticias = noticiasSeleccionadas;
            
            const container = document.getElementById('listaNoticasContainer');
            
            container.innerHTML = noticias.map(noticia => `
                <div class="news-item">
                    <h4>${noticia.titulo}</h4>
                    <p>${noticia.resumen}</p>
                    <small style="color: #94a3b8;">ğŸ“‚ ${noticia.categoria}</small>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-whatsapp" onclick="compartirNoticia(${noticia.id})">ğŸ“± Compartir</button>
                        <button class="btn btn-success" onclick="crearPostNoticia(${noticia.id})">ğŸ“ Crear Post</button>
                    </div>
                </div>
            `).join('');
            
            showAlert('ğŸ“° Noticias mundiales actualizadas');
        }

        function compartirNoticia(id) {
            const noticia = noticias.find(n => n.id === id);
            if (!noticia) return;
            
            const mensaje = `ğŸ“° ${noticia.titulo}

${noticia.resumen}

Â¿Te interesa saber mÃ¡s sobre este tema?

En Urbana Vision siempre estamos al dÃ­a con las Ãºltimas tendencias.

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Noticia compartida');
        }

        function compartirEnlaceNoticia() {
            const enlace = document.getElementById('enlaceNoticia').value.trim();
            const mensaje = document.getElementById('mensajeNoticia').value.trim();
            
            if (!enlace) {
                showAlert('âŒ Pegue un enlace de noticia para compartir');
                return;
            }
            
            const mensajeCompleto = mensaje ? `${mensaje}\n\n${enlace}` : enlace;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensajeCompleto)}`, '_blank');
            showAlert('ğŸ“± Enlace de noticia compartido');
            
            // Limpiar campos
            document.getElementById('enlaceNoticia').value = '';
            document.getElementById('mensajeNoticia').value = 'ğŸ“° Mira esta noticia interesante:\n\nğŸ“± 809-713-5307';
        }

        function crearPostNoticia(id) {
            const noticia = noticias.find(n => n.id === id);
            if (!noticia) return;
            
            const post = `ğŸ“° ${noticia.titulo}

${noticia.resumen}

Â¿SabÃ­as esto? En Urbana Vision siempre estamos informados sobre las Ãºltimas tendencias en salud visual.

Â¡Ven y descubre cÃ³mo podemos ayudarte!

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com

#UrbanaVision #SaludVisual #OpticaRD`;
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(post).then(() => {
                showAlert('ğŸ“‹ Post copiado al portapapeles');
            }).catch(() => {
                window.open(`https://wa.me/18097135307?text=${encodeURIComponent(post)}`, '_blank');
            });
        }

        // ========================================
        // ğŸ‘¥ FUNCIONES DE CLIENTES
        // ========================================
        function agregarCliente() {
            const nombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefonoCliente').value.trim();
            
            if (!nombre || !telefono) {
                showAlert('âŒ Complete nombre y telÃ©fono');
                return;
            }
            
            const cliente = {
                id: Date.now(),
                nombre: nombre,
                telefono: telefono,
                fecha: new Date().toISOString()
            };
            
            clientes.push(cliente);
            guardarDatos();
            cargarClientes();
            
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefonoCliente').value = '';
            
            showAlert('âœ… Cliente agregado');
        }

        function cargarClientes() {
            const lista = document.getElementById('listaClientes');
            
            if (clientes.length === 0) {
                lista.innerHTML = '<p>No hay clientes registrados</p>';
                return;
            }
            
            lista.innerHTML = clientes.map(c => `
                <div class="cliente-item">
                    <div style="flex: 1;">
                        <h4>${c.nombre}</h4>
                        <p>ğŸ“± ${c.telefono}</p>
                    </div>
                    <div>
                        <button class="btn btn-whatsapp" onclick="contactarCliente('${c.telefono}', '${c.nombre}')">ğŸ’¬ Contactar</button>
                        <button class="btn btn-danger" onclick="eliminarCliente(${c.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function contactarCliente(telefono, nombre) {
            const mensaje = `Â¡Hola ${nombre}! âœ¨

Te contacto desde Urbana Vision.

Â¿CÃ³mo has estado?

Tenemos nuevas ofertas que te pueden interesar.

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`;
            
            const telefonoLimpio = telefono.replace(/[^0-9]/g, '');
            window.open(`https://wa.me/1${telefonoLimpio}?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        function eliminarCliente(id) {
            if (confirm('Â¿Eliminar este cliente?')) {
                clientes = clientes.filter(c => c.id !== id);
                guardarDatos();
                cargarClientes();
                showAlert('âœ… Cliente eliminado');
            }
        }

        // ========================================
        // ğŸ“Š FUNCIONES DE REPORTES COMPLETOS
        // ========================================
        function cargarReportes() {
            // Calcular totales
            const totalVentas = ventas.reduce((sum, v) => sum + v.monto, 0);
            const totalPorCobrar = cuentasPorCobrar.reduce((sum, c) => sum + c.saldo, 0);
            const totalPorPagar = cuentasPorPagar.reduce((sum, p) => sum + p.saldo, 0);
            
            document.getElementById('totalVentas').textContent = `RD$ ${totalVentas.toFixed(2)}`;
            document.getElementById('totalPorCobrar').textContent = `RD$ ${totalPorCobrar.toFixed(2)}`;
            document.getElementById('totalPorPagar').textContent = `RD$ ${totalPorPagar.toFixed(2)}`;
            
            // Estado laboratorio
            const ordenesEnProceso = ordenesLab.filter(o => o.estado === 'enviado').length;
            const ordenesListas = ordenesLab.filter(o => o.estado === 'entregado').length;
            
            document.getElementById('ordenesEnProceso').textContent = ordenesEnProceso;
            document.getElementById('ordenesListas').textContent = ordenesListas;
            
            // Ventas recientes
            const ventasRecientes = document.getElementById('ventasRecientes');
            if (ventas.length === 0) {
                ventasRecientes.innerHTML = '<p>No hay ventas registradas</p>';
            } else {
                ventasRecientes.innerHTML = ventas.slice(-5).reverse().map(v => `
                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin: 5px 0;">
                        <strong>RD$ ${v.monto.toFixed(2)}</strong> - ${v.descripcion}
                        <div style="font-size: 12px; opacity: 0.7;">${new Date(v.fecha).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }
        }

        function nuevaVenta() {
            const monto = prompt('Monto de la venta (RD$):');
            const descripcion = prompt('DescripciÃ³n de la venta:');
            
            if (monto && descripcion) {
                const venta = {
                    id: Date.now(),
                    monto: parseFloat(monto),
                    descripcion: descripcion.trim(),
                    fecha: new Date().toISOString()
                };
                
                ventas.push(venta);
                guardarDatos();
                cargarReportes();
                showAlert('âœ… Venta registrada');
            }
        }

        // ========================================
        // ğŸ’µ FUNCIONES DE CUENTAS POR COBRAR
        // ========================================
        function cargarCuentasPorCobrar() {
            const lista = document.getElementById('listaCuentasPorCobrar');
            
            if (cuentasPorCobrar.length === 0) {
                lista.innerHTML = '<p>No hay cuentas por cobrar</p>';
                return;
            }
            
            lista.innerHTML = cuentasPorCobrar.filter(c => c.saldo > 0).map(cuenta => `
                <div class="cliente-item">
                    <div style="flex: 1;">
                        <h4>${cuenta.cliente}</h4>
                        <p>${cuenta.descripcion}</p>
                        <p><strong>Saldo:</strong> RD$ ${cuenta.saldo.toFixed(2)}</p>
                        <p><strong>Total original:</strong> RD$ ${cuenta.montoOriginal.toFixed(2)}</p>
                        <p style="font-size: 12px; opacity: 0.7;">Fecha: ${new Date(cuenta.fecha).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <button class="btn btn-whatsapp" onclick="recordarPago('${cuenta.cliente}', ${cuenta.saldo})">ğŸ’¬ Recordar</button>
                        <button class="btn btn-success" onclick="abonarRapido(${cuenta.id})">ğŸ’° Abonar</button>
                    </div>
                </div>
            `).join('');
            
            // Llenar select de clientes
            const select = document.getElementById('clienteAbono');
            select.innerHTML = '<option value="">Seleccionar cliente existente</option>' +
                cuentasPorCobrar.filter(c => c.saldo > 0).map(c => 
                    `<option value="${c.cliente}">${c.cliente} - RD$ ${c.saldo.toFixed(2)}</option>`
                ).join('');
        }

        function recordarPago(cliente, saldo) {
            const mensaje = `Â¡Hola ${cliente}! ğŸ˜Š

Te recordamos que tienes un saldo pendiente de RD$ ${saldo.toFixed(2)} con Urbana Vision.

Â¿CuÃ¡ndo podrÃ­as pasar a abonar?

Gracias por tu preferencia.

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Recordatorio enviado');
        }

        function abonarRapido(cuentaId) {
            const monto = prompt('Monto del abono (RD$):');
            if (!monto || parseFloat(monto) <= 0) return;
            
            const cuenta = cuentasPorCobrar.find(c => c.id === cuentaId);
            if (!cuenta) return;
            
            const montoAbono = parseFloat(monto);
            cuenta.saldo -= montoAbono;
            
            if (cuenta.saldo < 0) cuenta.saldo = 0;
            
            guardarDatos();
            cargarCuentasPorCobrar();
            showAlert(`âœ… Abono de RD$ ${montoAbono.toFixed(2)} registrado para ${cuenta.cliente}`);
        }

        function registrarAbono() {
            const clienteSelect = document.getElementById('clienteAbono').value;
            const clienteManual = document.getElementById('clienteManualAbono').value.trim();
            const monto = parseFloat(document.getElementById('montoAbono').value);
            const concepto = document.getElementById('conceptoAbono').value.trim();
            
            const nombreCliente = clienteSelect || clienteManual;
            
            if (!nombreCliente || !monto || !concepto) {
                showAlert('âŒ Complete todos los campos');
                return;
            }
            
            // Si es cliente manual, auto-guardarlo
            if (clienteManual && !clienteSelect) {
                autoGuardarCliente(clienteManual);
            }
            
            // Buscar cuenta existente o crear nueva
            let cuenta = cuentasPorCobrar.find(c => c.cliente.toLowerCase() === nombreCliente.toLowerCase() && c.saldo > 0);
            
            if (!cuenta) {
                // Crear nueva cuenta por cobrar
                cuenta = {
                    id: Date.now(),
                    cliente: nombreCliente,
                    descripcion: concepto,
                    montoOriginal: monto,
                    saldo: monto,
                    fecha: new Date().toISOString()
                };
                cuentasPorCobrar.push(cuenta);
            } else {
                // Abonar a cuenta existente
                cuenta.saldo -= monto;
                if (cuenta.saldo < 0) cuenta.saldo = 0;
            }
            
            guardarDatos();
            cargarCuentasPorCobrar();
            
            // Limpiar campos
            document.getElementById('clienteAbono').value = '';
            document.getElementById('clienteManualAbono').value = '';
            document.getElementById('montoAbono').value = '';
            document.getElementById('conceptoAbono').value = '';
            
            showAlert(`âœ… Abono registrado para ${nombreCliente}`);
        }

        // ========================================
        // ğŸ“‹ FUNCIONES DE CUENTAS POR PAGAR
        // ========================================
        function cargarCuentasPorPagar() {
            const lista = document.getElementById('listaCuentasPorPagar');
            
            if (cuentasPorPagar.length === 0) {
                lista.innerHTML = '<p>No hay cuentas por pagar</p>';
                return;
            }
            
            lista.innerHTML = cuentasPorPagar.filter(p => p.saldo > 0).map(cuenta => `
                <div class="cliente-item">
                    <div style="flex: 1;">
                        <h4>ğŸ­ ${cuenta.laboratorio}</h4>
                        <p>${cuenta.descripcion}</p>
                        <p><strong>Saldo:</strong> RD$ ${cuenta.saldo.toFixed(2)}</p>
                        <p style="font-size: 12px; opacity: 0.7;">Fecha: ${new Date(cuenta.fecha).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="pagarRapido(${cuenta.id})">ğŸ’³ Pagar</button>
                    </div>
                </div>
            `).join('');
        }

        function pagarRapido(cuentaId) {
            const monto = prompt('Monto del pago (RD$):');
            if (!monto || parseFloat(monto) <= 0) return;
            
            const cuenta = cuentasPorPagar.find(c => c.id === cuentaId);
            if (!cuenta) return;
            
            const montoPago = parseFloat(monto);
            cuenta.saldo -= montoPago;
            
            if (cuenta.saldo < 0) cuenta.saldo = 0;
            
            guardarDatos();
            cargarCuentasPorPagar();
            showAlert(`âœ… Pago de RD$ ${montoPago.toFixed(2)} registrado a ${cuenta.laboratorio}`);
        }

        function pagarLaboratorio() {
            const laboratorio = document.getElementById('laboratorioManualPago').value.trim();
            const monto = parseFloat(document.getElementById('montoPago').value);
            
            if (!laboratorio || !monto) {
                showAlert('âŒ Complete laboratorio y monto');
                return;
            }
            
            // Buscar cuenta existente o crear nueva
            let cuenta = cuentasPorPagar.find(c => c.laboratorio.toLowerCase() === laboratorio.toLowerCase() && c.saldo > 0);
            
            if (!cuenta) {
                // Crear nueva cuenta por pagar
                cuenta = {
                    id: Date.now(),
                    laboratorio: laboratorio,
                    descripcion: 'Servicios de laboratorio',
                    saldo: monto,
                    fecha: new Date().toISOString()
                };
                cuentasPorPagar.push(cuenta);
            } else {
                // Pagar cuenta existente
                cuenta.saldo -= monto;
                if (cuenta.saldo < 0) cuenta.saldo = 0;
            }
            
            guardarDatos();
            actualizarDatalistLaboratorios();
            cargarCuentasPorPagar();
            
            // Limpiar campos
            document.getElementById('laboratorioManualPago').value = '';
            document.getElementById('montoPago').value = '';
            
            showAlert(`âœ… Pago registrado a ${laboratorio}`);
        }

        // ========================================
        // ğŸ“„ FUNCIONES DE FACTURACIÃ“N
        // ========================================
        function cargarFacturacion() {
            // Establecer fecha actual
            document.getElementById('fechaFactura').value = new Date().toISOString().split('T')[0];
            
            // Cargar facturas recientes
            const lista = document.getElementById('listaFacturasRecientes');
            if (facturas.length === 0) {
                lista.innerHTML = '<p>No hay facturas registradas</p>';
                return;
            }
            
            lista.innerHTML = facturas.slice(-10).reverse().map(f => `
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>ğŸ“„ ${f.ncf}</h4>
                    <p><strong>Cliente:</strong> ${f.cliente}</p>
                    <p><strong>Total:</strong> RD$ ${f.total.toFixed(2)}</p>
                    <p><strong>Saldo:</strong> RD$ ${f.saldo.toFixed(2)}</p>
                    <p style="font-size: 12px; opacity: 0.7;">Fecha: ${new Date(f.fecha).toLocaleDateString()}</p>
                    <button class="btn btn-whatsapp" onclick="reenviarFactura(${f.id})">ğŸ“± Reenviar</button>
                </div>
            `).join('');
        }

        function generarNCF() {
            const tipo = document.getElementById('tipoComprobante').value;
            if (!tipo) return;
            
            const numero = contadorNCF[tipo].toString().padStart(8, '0');
            const ncf = `${tipo}${numero}`;
            
            document.getElementById('ncfFactura').value = ncf;
        }

        function calcularTotales() {
            const subtotal = parseFloat(document.getElementById('subtotalFactura').value) || 0;
            const itbis = subtotal * 0.18;
            const total = subtotal + itbis;
            
            document.getElementById('itbisFactura').value = itbis.toFixed(2);
            document.getElementById('totalFactura').value = total.toFixed(2);
            
            calcularSaldo();
        }

        function calcularSaldo() {
            const total = parseFloat(document.getElementById('totalFactura').value) || 0;
            const abono = parseFloat(document.getElementById('abonoFactura').value) || 0;
            const saldo = total - abono;
            
            document.getElementById('saldoFactura').value = saldo.toFixed(2);
        }

        function generarFactura() {
            const cliente = document.getElementById('clienteManualFactura').value.trim();
            const tipo = document.getElementById('tipoComprobante').value;
            const ncf = document.getElementById('ncfFactura').value;
            const fecha = document.getElementById('fechaFactura').value;
            const descripcion = document.getElementById('descripcionFactura').value.trim();
            const subtotal = parseFloat(document.getElementById('subtotalFactura').value) || 0;
            const total = parseFloat(document.getElementById('totalFactura').value) || 0;
            const abono = parseFloat(document.getElementById('abonoFactura').value) || 0;
            const saldo = parseFloat(document.getElementById('saldoFactura').value) || 0;
            
            if (!cliente || !tipo || !descripcion || !subtotal) {
                showAlert('âŒ Complete todos los campos obligatorios');
                return;
            }
            
            // Auto-guardar cliente
            autoGuardarCliente(cliente);
            
            // Crear factura
            const factura = {
                id: Date.now(),
                numero: Date.now().toString().slice(-8),
                cliente: cliente,
                tipo: tipo,
                ncf: ncf,
                fecha: fecha,
                descripcion: descripcion,
                subtotal: subtotal,
                itbis: subtotal * 0.18,
                total: total,
                abono: abono,
                saldo: saldo,
                fechaCreacion: new Date().toISOString()
            };
            
            facturas.push(factura);
            
            // Actualizar contador NCF
            contadorNCF[tipo]++;
            
            // Si hay saldo, crear cuenta por cobrar
            if (saldo > 0) {
                const cuentaCobrar = {
                    id: Date.now() + 1,
                    facturaId: factura.id,
                    cliente: cliente,
                    descripcion: `Factura ${ncf} - ${descripcion}`,
                    montoOriginal: saldo,
                    saldo: saldo,
                    fecha: new Date().toISOString()
                };
                cuentasPorCobrar.push(cuentaCobrar);
            }
            
            guardarDatos();
            cargarFacturacion();
            
            showAlert(`âœ… Factura ${ncf} generada correctamente`);
        }

        function enviarFacturaPorWhatsApp() {
            const cliente = document.getElementById('clienteManualFactura').value.trim();
            const ncf = document.getElementById('ncfFactura').value;
            const total = document.getElementById('totalFactura').value;
            const saldo = document.getElementById('saldoFactura').value;
            
            if (!cliente || !ncf) {
                showAlert('âŒ Genere la factura primero');
                return;
            }
            
            const mensaje = `ğŸ“„ FACTURA URBANA VISION

ğŸ‘¤ Cliente: ${cliente}
ğŸ“‹ NCF: ${ncf}
ğŸ’° Total: RD$ ${total}
ğŸ’³ Saldo pendiente: RD$ ${saldo}

Gracias por su preferencia.

ğŸ“± 809-713-5307
ğŸŒ urbanavision.com`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Factura enviada por WhatsApp');
        }

        function imprimirFactura() {
            showAlert('ğŸ–¨ï¸ FunciÃ³n de impresiÃ³n disponible prÃ³ximamente');
        }

        function reenviarFactura(id) {
            const factura = facturas.find(f => f.id === id);
            if (!factura) return;
            
            const mensaje = `ğŸ“„ FACTURA URBANA VISION

ğŸ‘¤ Cliente: ${factura.cliente}
ğŸ“‹ NCF: ${factura.ncf}
ğŸ’° Total: RD$ ${factura.total.toFixed(2)}
ğŸ’³ Saldo pendiente: RD$ ${factura.saldo.toFixed(2)}

ğŸ“± 809-713-5307`;
            
            window.open(`https://wa.me/18097135307?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('ğŸ“± Factura reenviada');
        }
    </script>
</body>
</html>
